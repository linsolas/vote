<!--
  PIN CODE
  This is a pin code, a component where the user has to input with 4 digits to access one vote session (the vote section
  or the results section).
    * `page`: type of page (`vote` or `results`).
-->
<dom-module id="pin-code">
  <style>
    .pin-code-input {
      letter-spacing: 10px;
      width: 160px;
      padding: 0;
      margin: 0;
      display: inline;
      text-align: center;
      font-size: 30px;
      float: left;
      border-radius: 5px;
    }
    .pin-code-input:focus {
      outline: 0;
      border-color: rgba(82, 168, 236, .6);
      box-shadow: 0 0 8px rgba(82, 168, 236, .6);
    }
    /* To hide the up & down arrows for input type number on Webkit browsers. */
    .pin-code-input::-webkit-outer-spin-button,
    .pin-code-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
    }

    .pin-code-block {
      display: inline-block;
    }
    #goButton {
      margin-left: 50px;
    }

    @media (max-width: 768px) {
      #goButton {
        margin-left: 10px;
      }
    }
    .campaign-not-found {
      margin-top: 30px;
    }
  </style>

  <template>
    <div class="container" id="pinCodeContainer">
      <div class="row">
        <div class="col-sm-12">
          <h4>[[localizedTitle]]</h4>
        </div>

        <div id="pinCode" class="col-sm-12 text-center">
          <div class="pin-code-block">
            <input id="pinCodeInput"
                   type="[[inputType]]"
                   maxlength="4"
                   pattern="[0-9]*"
                   inputmode="numeric"
                   class="form-control input-lg pin-code-input">

            <button class="btn btn-primary btn-lg" disabled id="goButton" type="button" on-tap="goVote">
              <template is="dom-if" if="{{!loading}}">Go!</template>
              <template is="dom-if" if="{{loading}}"><i class="fa fa-spin fa-spinner"></i></template>
            </button>
          </div>
        </div>
        <div class="clearfix"></div>

        <!-- Error, campaign not found or closed -->
        <template is="dom-if" if="{{errorCode}}">
          <div role="alert" class="alert alert-danger campaign-not-found">
            <button data-dismiss="alert" class="close" type="button">
              <span aria-hidden="true">x</span><span class="sr-only">Close</span>
            </button>
            <strong>[[localize(errorCode)]]</strong><br>
            [[localize('pinCode.tryAgain')]]
          </div>
        </template>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'pin-code',
      properties: {
        page: String,
        code: {
          type: Number,
          notify: true,
          observer: 'codeChanged',
          value: ''
        }
      },
      ready: function() {
        if (this.page === 'results') {
          this.inputType = 'password';
          this.localizedTitle = this.localize('pinCode.resultsTitle');
        } else {
          this.inputType = 'number';
          this.localizedTitle = this.localize('pinCode.voteTitle');
        }
        this.loading = false;
      },

      // Get the `XXX` from [url]?code=XXX&...
      // Thank you http://stackoverflow.com/a/11582513/26457
      _getURLParameter: function(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
      },

      // Initialization
      attached: function() {
        var wc = this;
        var $input = $('#pinCodeInput');
        $input.on('keyup', function(evt) {
          if (evt.keyCode === 13 && wc._validNumber()) {
            // ENTER key
            wc.goVote();
          } else {
            var code = $(this).val();
            wc.code = code;
          }
        });
        $input.focus();

        // Check if a campaign ID exists in query parameter or in session storage, so we remove the pin code.
        if (this.page === 'results') {
          var ssCode = this._getURLParameter('code');
          if (ssCode === null) {
            sessionStorage.getItem('campaign-key');
          }
          if (ssCode !== null) {
            window.firebaseUtils.getCampaignConfig(ssCode, function(campaignConfig) {
              if (campaignConfig && campaignConfig.jury) {
                $('#pinCodeContainer').effect('drop', function() {
                  this.fire('gbislab-access-campaign', campaignConfig);
                }.bind(this));
              }
            }.bind(this));
          }
        }
      },

      // Use mini-i18n to localize messages
      localize: function(key) {
        return window.GBISLabLocalizer.localize(key);
      },

      // Is the current code valid (should be of 4 numbers)
      _validNumber: function() {
        return this.code.length === 4 && !isNaN(parseInt(this.code, 10))
      },

      // The code has been changed. Is it valid?
      codeChanged: function() {
        var items = this.$$('input');
        if (this._validNumber()) {
          items.classList.add('has-success');
          items.classList.remove('has-error');
          this.$.goButton.disabled = false;
        } else {
          items.classList.add('has-error');
          items.classList.remove('has-success');
          this.$.goButton.disabled = true;
        }
      },

      displayError: function(key) {
        this.waitBeforeSubmit = true;
        $('.pin-code-block input').effect('shake', function() {
          $('#pinCodeInput').focus().select();
          this.waitBeforeSubmit = false;
        }.bind(this));
        // No campaign found or campaign closed, display error...
        this.errorCode = key;
      },

      // Go to the vote, if the session exists...
      goVote: function() {
        // To avoid having the animation several times
        if (this.waitBeforeSubmit) {
          return;
        }
        this.loading = true;
        window.firebaseUtils.getCampaignConfig(this.code, function(campaignConfig) {
          // If the pincode is used to display the results, we need to have the jury access, not the normal one.
          this.loading = false;
          if (campaignConfig == null || (this.page === 'results' && !campaignConfig.jury)) {
            return this.displayError('pinCode.notFound');
          }
          // We found the campaign. We allow the access if:
          //   - the session is not closed
          //   - the session is closed, but we want to see the results as a jury
          // otherwise => error
          if (!campaignConfig.closed || (this.page === 'results' && campaignConfig.jury)) {
            if (this.page === 'results') {
              sessionStorage.setItem('campaign-key', this.code);
            }
            $('#pinCodeContainer').effect('drop', function() {
              this.fire('gbislab-access-campaign', campaignConfig);
            }.bind(this));
          } else {
            return this.displayError('pinCode.closed');
          }
        }.bind(this));
      }
    });
  </script>
</dom-module>
